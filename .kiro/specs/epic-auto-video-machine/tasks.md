# Epic Auto Video Machine - 實作任務清單

## 專案設置和基礎架構

- [x] 1. 建立專案基礎結構和開發環境
  - 建立 Next.js 14 專案結構，配置 TypeScript 和 Tailwind CSS
  - 設置 ESLint、Prettier 和 Husky git hooks
  - 配置環境變數管理 (.env.local, .env.example)
  - 建立基本的資料夾結構 (src/app, src/components, src/lib, src/types)
  - 配置 Framer Motion 動效庫和設計 tokens
  - _需求: 13.1, 13.2, 13.3_

- [x] 2. 設置資料庫和 ORM
  - 配置 Neon Postgres 資料庫連接
  - 設置 Prisma ORM 和 schema 定義
  - 建立資料庫遷移腳本 (projects, jobs, scenes, assets, presets 表)
  - 實作 Row Level Security 政策確保多租戶隔離
  - 實作資料庫連接池和錯誤處理
  - _需求: 8.1, 8.2, 12.1, 12.2_

- [x] 3. 實作認證和授權系統
  - 整合 NextAuth.js 與 OAuth 提供商 (Google, GitHub, Discord)
  - 建立用戶模型和 JWT token 管理（24 小時過期）
  - 實作 RBAC 權限系統 (user/premium/admin) 和中介軟體
  - 實作多租戶隔離和資料加密（靜態/傳輸）
  - _需求: 12.1, 12.2, 12.3, 12.4_

## 核心 API 服務

- [x] 4. 建立 API 路由基礎架構
  - 設置 Next.js API 路由結構 (/api/v1/\*)
  - 實作 API 中介軟體 (認證、速率限制、錯誤處理)
  - 建立統一的 API 回應格式和錯誤處理
  - 實作請求驗證和 Zod schema
  - 實作 API 可用性監控（目標 99.5%）
  - _需求: 1.1, 8.1, 10.3, 15.1_

- [x] 4.1 實作設計系統和 UI 基礎元件
  - 建立 Tailwind CSS 設計 tokens（漸層色彩、字體、圓角）
  - 實作基礎 UI 元件（Button, Card, Modal, Input）
  - 建立玻璃擬態效果和動效系統
  - 實作響應式佈局和暗色模式支援
  - _需求: 13.1, 13.2, 13.3, 13.4_

- [ ] 5. 實作專案管理 API
  - 建立 POST /api/v1/projects 端點 (建立專案)
  - 建立 GET /api/v1/projects 端點 (列出專案)
  - 建立 GET /api/v1/projects/[id] 端點 (取得專案詳情)
  - 建立 PUT /api/v1/projects/[id] 端點 (更新專案)
  - 實作專案狀態管理和驗證邏輯
  - _需求: 1.5, 8.2_

- [ ] 6. 實作檔案上傳和解析服務
  - 建立 POST /api/v1/projects/[id]/upload 端點
  - 實作多格式檔案解析 (.txt, .md, .docx, .pdf)
  - 建立文字清洗和正規化功能
  - 實作檔案大小和內容長度驗證
  - 整合 Cloudflare R2 儲存服務
  - _需求: 1.1, 1.2, 1.3, 1.4_

## Gemini API 整合核心

- [ ] 7. 建立 Gemini API 客戶端基礎架構
  - 安裝最新 google-genai SDK（GA 版本，取代舊版 google-generativeai）
  - 建立模型常數管理（gemini-2.5-flash, gemini-2.5-flash-preview-tts, imagen-4.0-generate-preview-06-06）
  - 實作 BYO API 金鑰支援和安全儲存
  - 建立 Free Tier 限額護欄（文字 10 RPM, TTS 3 RPM, 圖像 10 RPM）
  - 實作區域可用性檢查和回退策略
  - _需求: 4.1, 11.5, 10.4, 10.5_

- [ ] 7.1 升級現有 Gemini 代碼到最新 SDK
  - 檢查並升級現有 gemini_text.py/gemini_tts.py/gemini_image.py 到 google-genai
  - 移除舊版 google-generativeai 依賴（2025-11-30 後停止更新）
  - 更新所有 API 調用語法到新版 SDK 格式
  - 建立 REST 備援方案以便無 SDK 環境時測試
  - _需求: 技術債務清理和未來兼容性_

- [ ] 7.2 實作 Gemini 錯誤處理和重試機制
  - 建立錯誤分類系統（429 限流、配額超限、內容政策、超時等）
  - 實作指數退避重試策略（觸發 429 時自動退避）
  - 建立降級策略（生圖失敗用佔位圖、TTS 失敗保留文字）
  - 實作併發閥值控制和「排隊中」UI 提示
  - _需求: 4.5, 5.6, 6.6, 8.3_

## 場景處理和文字分析

- [ ] 8. 實作場景切分服務
  - 建立基於規則的場景切分算法 (100-280 字)
  - 整合 Gemini Text API 進行語義切分
  - 實作場景合併、拆分和重排功能
  - 建立場景預覽和編輯 API
  - 實作中文文字正規化（全形/半形、標點符號）
  - _需求: 2.1, 2.2, 2.3, 2.4, 2.5, 16.5_

- [ ] 9. 實作提示詞生成服務
  - 建立場景到視覺提示詞的轉換邏輯
  - 實作英文化和視覺要素提取（主體/環境/鏡頭/光影/情緒）
  - 建立內容安全過濾和替代方案生成
  - 實作提示詞預覽和編輯功能
  - 建立模板化提示詞系統避免違規詞
  - _需求: 4.1, 4.2, 4.3, 4.4, 4.5_

## 媒體生成服務

- [ ] 10. 實作圖像生成服務
  - 優先整合 Imagen 4 API 支援精準比例（aspectRatio: "9:16"/"16:9"/"1:1"）
  - 實作 Gemini 原生生圖作為備選（需設定 response_modalities=["TEXT","IMAGE"]）
  - 建立圖像品質評估和自動選擇邏輯（多張生成時）
  - 實作智慧裁切和安全框處理（僅 Gemini 原生生圖需要）
  - 實作圖像儲存和 Cloudflare R2/CDN 整合
  - _需求: 5.1, 5.2, 5.3, 5.4, 5.5, 5.6_

- [ ] 11. 實作 TTS 語音合成服務
  - 整合 Gemini TTS API（gemini-2.5-flash-preview-tts）進行語音生成
  - 實作 response_modalities=["AUDIO"] 和 speech_config 必填參數
  - 建立語音映射（男聲/女聲/自然聲 → Kore/Puck 等 prebuilt voices）
  - 實作 PCM 到 WAV 轉換（24kHz/mono/s16le 固定參數）
  - 建立智慧斷句和停頓插入邏輯
  - _需求: 6.1, 6.2, 6.3, 6.4, 6.5, 6.6, 16.2, 16.3_

- [ ] 12. 實作字幕生成服務
  - 建立文字到字幕時間軸對應邏輯
  - 實作 SRT 和 VTT 格式輸出
  - 建立字幕同步和校正功能
  - 實作多語言字幕支援
  - _需求: 6.5_

## 模板系統和視覺風格

- [ ] 13. 實作三種預設模板系統
  - 建立 Classic Clean 模板（白底細陰影 + 輕轉場）
  - 建立 Dark Glass 模板（深色玻璃擬態風格）
  - 建立 Vivid Gradient 模板（鮮豔漸層背景）
  - 實作模板預覽和即時切換功能
  - 建立模板配置的序列化和儲存機制
  - _需求: 14.1, 14.2, 14.3, 14.4, 14.5_

## 影片渲染和合成

- [ ] 14. 建立影片渲染服務架構
  - 設計雲端渲染 API 整合架構（FFmpeg 服務或第三方 API）
  - 實作渲染任務佇列和狀態管理
  - 建立多比例影片輸出支援（避免二次縮放）
  - 實作渲染進度追蹤和錯誤處理
  - 建立渲染效能監控（目標 15 分鐘內完成 99% 任務）
  - _需求: 7.1, 7.6, 15.2_

- [ ] 15. 實作影片合成邏輯
  - 建立圖片序列到影片的轉換邏輯
  - 實作轉場效果 (淡化 500ms、縮放、無轉場)
  - 建立音頻混合和 ducking 功能
  - 實作字幕疊加和時間軸同步
  - _需求: 7.1, 7.2, 7.3, 7.4, 7.5_

- [ ] 16. 實作背景音樂和音頻處理
  - 建立背景音樂庫和選擇邏輯
  - 實作 RMS 正規化和音量控制
  - 建立旁白優先的 ducking 算法（BGM -18 LUFS）
  - 實作最終音頻混合和輸出
  - _需求: 7.3, 7.4_

## 工作流編排和任務管理

- [ ] 16. 設置工作流編排系統
  - 整合 Temporal Cloud 或實作簡化的任務佇列
  - 建立工作流狀態機 (INGEST → SEGMENT → PROMPT → IMAGE → TTS → RENDER → PUBLISH)
  - 實作任務重試和錯誤恢復邏輯
  - 建立工作流監控和日誌記錄
  - _需求: 8.1, 8.2, 8.3, 8.4_

- [ ] 17. 實作任務狀態管理 API
  - 建立 POST /api/v1/projects/[id]/run 端點 (啟動任務)
  - 建立 GET /api/v1/jobs/[id] 端點 (查詢任務狀態)
  - 實作任務重試和取消功能
  - 建立即時狀態更新 (WebSocket 或 Server-Sent Events)
  - _需求: 8.1, 8.2, 8.5, 8.6_

- [ ] 18. 實作部分重試和回滾功能
  - 建立任務檢查點和狀態快照
  - 實作從任意步驟重新開始的邏輯
  - 建立版本管理和參數回滾功能
  - 實作審計日誌和操作記錄
  - _需求: 8.4, 8.5, 8.6_

## 成本管理和監控

- [ ] 19. 實作成本估算系統
  - 建立基於場景數和配置的成本計算邏輯（LLM + Image + TTS + Render）
  - 實作即時成本追蹤和更新（±20% 誤差範圍）
  - 建立成本預警和限制機制
  - 實作成本分析和報告功能
  - 建立 BYO 金鑰的成本豁免邏輯
  - _需求: 10.1, 10.2, 10.3, 10.4, 10.5_

- [ ] 20. 建立監控和日誌系統
  - 實作結構化日誌記錄和相關 ID 追蹤
  - 建立效能指標收集 (回應時間、成功率)
  - 實作錯誤監控和警報系統
  - 建立使用量統計和分析儀表板
  - _需求: 8.6, 10.2_

## 前端使用者介面

- [ ] 21. 建立首頁和專案儀表板
  - 實作響應式首頁設計（漸層主色 #7C3AED → #06B6D4、玻璃擬態）
  - 建立專案列表和狀態顯示
  - 實作專案搜尋和篩選功能
  - 建立快速建立專案的 CTA 按鈕
  - 實作近期專案和範本入口
  - _需求: 1.5, 3.1, 3.2, 13.1, 13.2_

- [ ] 22. 實作檔案上傳介面
  - 建立大區塊拖拽上傳區域（「把故事檔拖進來，或點此上傳」）
  - 實作檔案格式驗證和錯誤提示
  - 建立純文字貼上和雲端連結支援（Google Docs/Notion）
  - 實作上傳進度和即時回饋動效
  - 建立字數檢查和即時解析預覽
  - _需求: 1.1, 1.2, 1.3, 1.4, 1.5_

- [ ] 23. 建立場景編輯器介面
  - 實作場景列表和預覽顯示
  - 建立場景合併、拆分和重排功能
  - 實作場景文字編輯和即時預覽
  - 建立批次操作和一鍵接受功能
  - _需求: 2.2, 2.3, 2.4, 2.5_

- [ ] 24. 實作模板和配置選擇器
  - 建立比例選擇器 (9:16/16:9/1:1) 和安全框預覽
  - 實作模板選擇 (Classic Clean, Dark Glass, Vivid Gradient) 和即時預覽
  - 建立語音選擇器（男/女/自然聲）和語速控制
  - 建立「更多設定」展開區域收納進階選項
  - 實作即時成本估算顯示（NT$ 區間）
  - _需求: 3.1, 3.2, 3.3, 3.4, 3.5, 14.1, 14.2, 14.3_

- [ ] 25. 建立任務進度追蹤介面
  - 實作 DAG 進度視覺化顯示
  - 建立即時狀態更新和進度條
  - 實作錯誤顯示和重試按鈕
  - 建立任務日誌和詳細資訊面板
  - _需求: 8.1, 8.2, 8.3, 8.6_

## 資產管理和分享

- [ ] 26. 實作資產管理系統
  - 建立 GET /api/v1/assets/[id] 端點 (簽名下載)
  - 實作資產生命週期管理和自動清理
  - 建立資產預覽和縮圖生成
  - 實作資產搜尋和分類功能
  - _需求: 9.1, 9.5_

- [ ] 27. 建立檔案下載和分享功能
  - 實作最終影片和相關檔案的打包下載
  - 建立簽名 URL 和時效性控制
  - 實作公共分享頁面和權限管理
  - 建立分享連結的統計和追蹤
  - _需求: 9.1, 9.2, 9.3, 9.4_

## 用戶設定和偏好

- [ ] 28. 實作用戶設定系統
  - 建立設定頁面和分類導航
  - 實作一般設定 (語言、時區、預設模板)
  - 建立生成設定 (圖片數量、轉場、BGM)
  - 實作內容安全和通知設定
  - _需求: 11.1, 11.2, 11.3, 11.4_

- [ ] 29. 建立 BYO API 金鑰管理
  - 實作 API 金鑰安全儲存和加密
  - 建立金鑰驗證和狀態檢查
  - 實作金鑰使用統計和配額監控
  - 建立金鑰輪換和管理功能
  - _需求: 11.5, 10.4_

## 測試和品質保證

- [ ] 30. 建立單元測試套件
  - 實作核心邏輯的單元測試 (場景切分、成本計算)
  - 建立 API 端點的整合測試
  - 實作錯誤處理和重試機制的測試
  - 建立測試資料和 mock 服務
  - _需求: 所有需求的驗證_

- [ ] 31. 實作端到端測試
  - 建立完整影片生成流程的 E2E 測試
  - 實作多比例和多模板的測試案例
  - 建立錯誤恢復和重試的測試
  - 實作效能和負載測試
  - _需求: 所有需求的整合驗證_

## 部署和維運

- [ ] 32. 設置 CI/CD 流水線
  - 建立 GitHub Actions 工作流程
  - 實作自動化測試和程式碼品質檢查
  - 建立自動化部署到 Vercel/Cloudflare
  - 實作環境變數和秘鑰管理
  - _需求: 系統可靠性和維護性_

- [ ] 33. 實作監控和警報系統
  - 建立應用程式效能監控 (APM)
  - 實作錯誤追蹤和警報通知
  - 建立使用量和成本監控儀表板
  - 實作健康檢查和自動恢復機制
  - _需求: 系統可觀測性和穩定性_

## 國際化和多語言支援

- [ ] 34. 實作多語言和國際化
  - 建立 i18n 系統支援繁體中文和英文
  - 實作時區設定和本地化時間顯示
  - 建立語言切換和用戶偏好儲存
  - 實作中文字幕和英文字幕格式支援
  - 建立台灣腔、大陸腔、香港腔語音選項
  - _需求: 16.1, 16.2, 16.3, 16.4, 16.5_

## 最終整合和優化

- [ ] 35. 進行系統整合測試
  - 執行完整的端到端測試流程（三種比例）
  - 驗證所有 API 端點和功能整合
  - 測試錯誤處理和邊界條件
  - 驗證效能要求（99.5% 可用性、15 分鐘完成率 99%）
  - 測試成本估算準確性（±20% 誤差）
  - _需求: 所有需求的最終驗證, 15.1, 15.2, 15.4_

- [ ] 36. 效能優化和調校
  - 優化資料庫查詢和索引
  - 實作快取策略和 Cloudflare CDN 配置
  - 優化圖片和影片處理效能
  - 調校工作流編排和併發處理
  - 實作自動擴展和負載均衡
  - _需求: 系統效能和使用者體驗, 15.5_

- [ ] 37. 準備生產環境部署
  - 配置生產環境的基礎設施（Vercel/Cloudflare）
  - 實作資料備份和災難恢復（30 天保留政策）
  - 建立監控和警報系統（APM、錯誤追蹤）
  - 準備使用者文件和支援材料
  - 實作漸進式部署（canary 5%）和快速回滾
  - _需求: 生產就緒和可維護性, 12.5_
